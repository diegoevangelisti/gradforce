<!DOCTYPE html>
<html lang="en">

<head>
  <script src="http://code.jquery.com/jquery-1.11.2.min.js" type="text/javascript"></script>
  <script src="https://cdn.rawgit.com/jackmoore/colorbox/master/jquery.colorbox-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.3/js.cookie.min.js"></script>
  <!-- One reload to refresh the content -->
  <script type='text/javascript'>
    (function () {
      if (window.localStorage) {
        if (!localStorage.getItem('firstLoad')) {
          localStorage['firstLoad'] = true;
          window.location.reload();
        } else
          localStorage.removeItem('firstLoad');
      }
    })();
  </script>
  <script>
    window.onload = function () {
      setTimeout(function () {
        document.body.style.opacity = "100";
      }, 300);
      window.scrollTo(0, 0);
    };
  </script>

  </script>
  <div w3-include-html="/partials/head.html"></div>

  <script>
    function includeHTML() {
      var z, i, elmnt, file, xhttp;
      /* Loop through a collection of all HTML elements: */
      z = document.getElementsByTagName("*");
      for (i = 0; i < z.length; i++) {
        elmnt = z[i];
        /*search for elements with a certain atrribute:*/
        file = elmnt.getAttribute("w3-include-html");
        if (file) {
          /* Make an HTTP request using the attribute value as the file name: */
          xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function () {
            if (this.readyState == 4) {
              if (this.status == 200) {
                elmnt.innerHTML = this.responseText;
              }
              if (this.status == 404) {
                elmnt.innerHTML = "Page not found.";
              }
              /* Remove the attribute, and call this function once more: */
              elmnt.removeAttribute("w3-include-html");
              includeHTML();
            }
          }
          xhttp.open("GET", file, true);
          xhttp.send();
          /* Exit the function: */
          return;
        }
      }
    }
  </script>
</head>

<body>
  <!-- for pop up message -->
  <link rel="stylesheet" href="/assets/css/colorbox.css" />

  <style>
    body {
      opacity: 0;
    }
  </style>
  <% include ./partials/header %>
  <main id="std-profile">
    <div id="std-details" class="box">
      <a id="std-details-edit">
        <img class="editbtn" src="/assets/img/icons/edit.png" alt="edit icon">
      </a>
      <% if(user.photo){ %>
      <img class="centerimg mb10" style="max-width: 300px; max-height: 300px;" src="<%= user.photo%>" alt="No photo">
      <% } %>
      <% if(!user.photo){ %>
      <img class="centerimg mb10" src="/assets/img/profile-placeholder.jpg" alt="No photo">
      <% } %>
      <h1 class="center" id="companyName"><%= user.companyName %></h1>
      <!-- <h2 class="center mb15" id="title"><%= user.title %></h2> -->
      <hr class="mb10">
      <h2 class="mb10">Contact Information</h2>
      <label for="email">Email address:</label>
      <p class="mb10"><%= user.email%></p>
      <% if(user.phone_number){ %>
      <label for="phone">Phone number:</label>
      <p class="mb10"><%= user.phone_number%></p>
      <% } %>
    </div>

    <!-- Modal for details section -->
    <div id="details-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="close" id="closeDetails" onclick="closeModal(id)">&times;</span>
          <h1>Personal Details</h1>
        </div>
        <div class="modal-body">
          <form id="edit-role-form" action="/profile/update-details/<%= user._id %>?_method=PUT" method="POST">
            <div id="edit-form-content">
              <label for="fname" class="mb2">
                Company name
              </label>
              <br>
              <input placeholder="Company name" name="companyName" id="company" class="text-input mb10"
                value="<%= user.companyName%>">
            </div>
            <div id="edit-form-content">
              <label for="title" class="mb2">
                Contact person
              </label>
              <br>
              <input placeholder="First name" name="fname" id="fname" class="text-input mb10" value="<%= user.fname%>">
              <input placeholder="Last name" name="lname" id="lname" class="text-input mb10" value="<%= user.lname%>">
            </div>
        </div>
        <div id="edit-form-content">
          <label for="phone" class="mb2">
            Phone
          </label>
          <br>
          <input name="phone" id="phone" class="text-input mb10" value="<%= user.phone_number%>">
        </div>
        <div class="modal-footer">
          <div id="modal-footer-buttons">
            <button type="button" id="cancel" class="btn btnGreen btnGray mt10">
              <span id="closeDetails" onclick="closeModal(id)">Cancel</span>
            </button>
            <button type="submit" class="btn btnGreen mt10">
              <span>Save</span>
            </button>
          </div>
        </div>
        </form>
      </div>
    </div>
    </div>


    <!-- About me paragraph -->
    <div id="std-about" class="box">
      <!-- Trigger/Open The Modal -->
      <div class="role-info">
        <a id="std-role-edit">
          <img class="editbtn" src="assets/img/icons/edit.png" alt="edit icon">
        </a>
        <h1 class="mb20">Description</h1>
        <p><%= user.about %></p>
      </div>
    </div>


    <!-- About popup for editing -->
    <!-- About modal -->
    <div id="about-modal" class="modal">
      <!-- About modal -->
      <div class="modal-content">
        <div class="modal-header">
          <span class="close" id="closeAbout" onclick="closeModal(id)">&times;</span>
          <h1>Description</h1>
        </div>
        <div class="modal-body">
          <form id="edit-role-form" action="/profile/update-about/<%= user._id%>?_method=PUT" method="POST">
            <div id="edit-form-content">
              <label for="about-summary" class="mb10 mt10">
                Describe the company
              </label>
              <br>
              <input maxlength="90" name="summary" id="role-summary" class="role text-input mt10 mb10"
                value="<%= user.about %>">
            </div>
            <div class="modal-footer">
              <div id="modal-footer-buttons">
                <button type="button" id="cancel" class="btn btnGreen btnGray mt10">
                  <span id="closeAbout" onclick="closeModal(id)">Cancel</span>
                </button>
                <button type="submit" class="btn btnGreen mt10">
                  <span>Save</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Role section -->
    <div id="std-education" class="box">
      <!-- Trigger/Open The Modal -->
      <div class="role-info">
        <a id="std-role-edit">
          <img class="editbtn" src="assets/img/icons/edit.png" alt="edit icon">
        </a>
        <h1 class="mb20">Roles</h1>
        <% user.role.forEach(function(role, i) { %>
        <% if(i) { %>
        <hr class="mt20 mb20">
        <% } %>
        <p class="mb10" style="font-weight: bold"><%= role.title %></p>
        <p class="mb10"><%= role.description %></p>
        <div class="mt20">
          <% for(j=0; j < role.skills.length; ++j) { %>
          <span class="mb10 inline skill-card"><%= role.skills[j] %></span>
          <% } %>
          <% }) %>
        </div>
      </div>
    </div>

    <!-- Role popup for editing -->
    <!-- Role Modal -->
    <div id="education-modal" class="modal">
      <!-- Role Modal content -->
      <div class="modal-content">
        <div class="modal-header">
          <span class="close" id="closeAbout" onclick="closeModal(id)">&times;</span>
          <h1>Roles</h1>
        </div>
        <div class="modal-body">
          <form id="edit-role-form" action="/profile/update-role/<%= user._id%>?_method=PUT" method="POST">
            <div id="edit-form-content">
              <label for="role-summary" class="mb10 mt10">
                Industry
              </label>
              <br>
              <input maxlength="90" name="summary" id="role-summary" class="role text-input mt10 mb10"
                value="<%= user.role %>">
            </div>
            <div class="modal-footer">
              <div id="modal-footer-buttons">
                <button type="button" id="cancel" class="btn btnGreen btnGray mt10">
                  <span id="closeAbout" onclick="closeModal(id)">Cancel</span>
                </button>
                <button type="submit" class="btn btnGreen mt10">
                  <span>Save</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

  </main>

  <!-- Model for Log in pop up message -->

  <div id="popup-modal" class="box" style="display: none; background: rgb(251, 251, 251);">
    <!-- <h2 class="center" id="title">Hi <%= user.fname %> <%= user.lname %> !</h2> -->
    <h2 class="center" style="font-weight: bold; font-size: 24px">Welcome to GradForce</h2>
    <br>
    <hr>
    <br>
    <p class="mb10 center">Please complete your profile so we can continue with the process.</p>
    <p class="mb10 center">Follow the instructions we sent you to <span
        style="font-weight: bold;"><%= user.email %></span></p><br>
    <h2 class="center" style="font-weight: bold; font-size: 20px">Thanks!</h2>
  </div>

  <div w3-include-html="/partials/footer.html"></div>

  <script>
    includeHTML();

    // Get the modals
    let detailsModal = document.getElementById("details-modal");
    let aboutModal = document.getElementById("role-modal");


    // Get the buttons that opens the modals

    //to edit
    let detailsEditBtn = document.getElementById("std-details-edit");
    let aboutEditBtn = document.getElementById("std-role-edit");

    // Get the <span> elements that close the modals
    var span = document.getElementsByClassName("close")[0];
    var cancelBtn = document.getElementById("cancel");

    // When the user clicks the button, open the specific modal 
    aboutEditBtn.onclick = function () {
      aboutModal.style.display = "block";
    }
  </script>

  <script>
    detailsEditBtn.onclick = function () {
      detailsModal.style.display = "block";
    }

    cancelBtn.onclick = function () {
      modal.style.display = "block";
    }


    function closeModal(modelName) {
      switch (modelName) {
        case "closeAbout":
          aboutModal.style.display = "none";
          break;
        case "closeDetails":
          detailsModal.style.display = "none";
          break;
        case "closeExperienceAdd":
          experienceModalAdd.style.display = "none";
          break;
        case "closeDeleteEducation":
          deleteEducationModal.style.display = "none";
          break;
      }
    }


    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {

      aboutModal.style.display = "none";
      detailsModal.style.display = "none";
      deleteExperienceModal.style.display = "none";

    }

    // When the user clicks anywhere outside of the modal, close it

    window.onclick = function (event) {
      if (event.target == aboutModal) {
        aboutModal.style.display = "none";
      } else
      if (event.target == detailsModal) {
        detailsModal.style.display = "none";
      }
    }
  </script>

  <!-- Added for pop up message -->
  <% popupCounter = 0 %>
  <% if(user.status == "Profile Complete" && popupCounter == 0){ %>
  <% popupCounter = 1 %>
  <script>
    var lastFocus;

    function onPopupOpen() {
      $("#std-profile").focus();
    }

    function onPopupClose() {

      //Cookie expires after 1 day
      Cookies.set('colorboxShown', 'yes', {
        expires: 1
      });
      var myElement = document.getElementById('popup-modal');
      myElement.style.display = 'none';
      lastFocus.focus();
    }

    function displayPopup() {

      var myElement = document.getElementById('popup-modal');
      myElement.style.display = "block";

      $.colorbox({
        inline: true,
        top: "20%",
        href: "#popup-modal",
        onComplete: onPopupOpen,
        onClosed: onPopupClose
      });
    }

    setTimeout(function () {
      // var popupShown = 0;
      var popupShown = Cookies.get('colorboxShown');

      if (popupShown) {
        console.log("Cookie found. No action necessary");
      } else {
        lastFocus = document.activeElement;
        displayPopup();
      }
    }, 2000);
  </script>
  <% } %>
  <script>
    var fileInput = document.getElementById('fileInput');
    var fileDisplayArea = document.getElementById('fileDisplayArea');
    var y;

    fileInput.addEventListener('change', function (e) {
      var file = fileInput.files[0];
      var imageType = /image.*/;

      if (file.type.match(imageType)) {
        var reader = new FileReader();

        reader.onload = function (e) {
          fileDisplayArea.innerHTML = "";

          var img = new Image();
          img.src = reader.result;
          img.setAttribute("class", "profile-img");


          fileDisplayArea.appendChild(img);

          y = document.createElement('a'); // is a node
          y.setAttribute("href", img.src);
          y.id = "newPhotoLink"
          fileDisplayArea.appendChild(y);
        }
        reader.readAsDataURL(file);

      } else {
        fileDisplayArea.innerHTML = "File not supported!"
      }
    });

    document.getElementById("detailsSubmit").onclick = () => {

      var newPhotoLink = document.getElementById("newPhotoLink").href;

      if (newPhotoLink)
        document.getElementById("newPhoto").value = newPhotoLink;

      $("#edit-details-form").submit();
    }
  </script>
</body>

</html>